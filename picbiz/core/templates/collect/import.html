

{% extends 'base.html' %}

{% block extracss %} {% endblock %}

{% block title %}Scan/Import Directory{% endblock %}


{% block navbar %}

<div style="position:fixed; background-color:#fff; width:100%;">


  </div>
  </div>



<div class="mui-row" style="padding:10px;">
<div class="mui-col-md-12">
      <div class="mui-col-md-3">
        {% include 'collect/partials/select-company.html' %}
      </div>

      <div class="mui-col-md-3">
        {% include 'collect/partials/select-section.html' %}
      </div>

      <div class="mui-col-md-3">
        {% include 'collect/partials/select-location.html' %}
      </div>

      <div class="mui-col-md-3">
        {% include 'collect/partials/select-subject.html' %}
      </div>
</div>


</div>
{% endblock %}


{% block main_header %} Processing  {{mkdir.name}} full path ({{path}}) {% endblock %}
{% block sub_header %}<div class="mui-panel mui-col-md-12" id="import-message"> Starting Import </div>{% endblock %}


{% block content %}

<div class="mui-row" style="margin:20px;">
  <div class="mui-col-md-12">
    <div id="file-list"> </div>
  </div>
</div>
{% endblock %}




{% block extrajs %}

<script src='/static/vendor/jquery/select_on_shift.js'></script>

<script type="text/plain" id="file-list-temp">

 <div class="mui-col-md-2 mui-panel">

      <a onclick='_scan.modal("<%= src %>", "<%= name %>");' target="_blank" >
      <img src="<%=thumb%>" id="img-<%= name %>" class="sm-img" data-src="<%=thumb%>" data-dir="<%= dir %>" />

      </a>

      <input type="checkbox" class="chkbox checkmark" name="selected-image" value="img-<%= name %>" data-dir="<%= dir %>" />


        <a data-dir="<%= dir %>" data-src="<%= name %>" class="rotate" > rotate </a>

        <table>
          <tbody>
          <tr><td>Date:</td><td><input id="img-<%= name %>-date" name="date" type="date"></td></tr>
          <tr><td>Company:</td><td><span id="img-<%= name %>-company-display"></span></td></tr>
          <tr><td>Section:</td><td><span id="img-<%= name %>-section-display"></span></td></tr>
          <tr><td>Location:</td><td><span id="img-<%= name %>-loc-display"></span></td></tr>
          <tr><td>Subject:</td><td><small><input type="text" id="img-<%=name%>-subject" name='subject' maxlength="255" ></small></td></tr>
          </tbody>
        <table>

         <input type="hidden" name="directory" value="<%= dir %>"  maxlength="255" required="" id="img-<%= name %>-dir" >
         <input type="hidden" name="name" value="<%= name %>" maxlength="255" required="" id="img-<%= name %>-name" >
         <input type="hidden" name="company_id" value="" id="img-<%= name %>-company" />
         <input type="hidden" name="section_id" value="" id="img-<%= name %>-section" />
         <input type="hidden" name="location_id" value="" id="img-<%= name %>-loc" />
        </div>

 </div>


</script>


<script>

//red, green, blue, egg yolk yellow, orange, purple, brown, black
  const  img_edit = {
    rotation_count:0,

    rotation:function(el){
      console.log(el);
      let dr = el.getAttribute("data-dir");
      let fn = el.getAttribute("data-src");
      img_edit.rotation_count += 1;
     _app.xhr_get('/img/edit/rotate', {'dir':dr, 'file_name': fn}, function(e){

      img = _app.el('img-'+fn);
      img_src = img.getAttribute('data-src');
      img.src = img_src += '?ver='+img_edit.rotation_count;
      console.log(_app.xhr_res(e));  } );
    },
};



  const _scan = {

      path:'',
      dir:'',
      imgs:[],
      locs:[],

      init:function(path, dir){

        this.events();
        this.path = path;
        this.dir = dir;
        this.msg = _app.el('import-message');
        this.get_locations();

      },


      events:function(){
      _app.event_bind('file-list', 'click', function(e) {
          if (e.target && e.target.matches("a.rotate")) {
            img_edit.rotation(e.target);
          }
          });
      },

      get_locations:function(){
        _scan.msg.innerHTML = 'Downloading Locations';
        _app.xhr_get('/location/index', {}, function(e){

        _scan.locs = _app.xhr_res(e).locations;
        _scan.msg.innerHTML = 'Buiding Thumbnails';
        _scan.get_list(_scan.path, _scan.dir);
        _scan.msg.innerHTML = 'Buiding List';


      });

      },

      get_list:function(path, dir){
        _app.xhr_post('/collect/thumbs', {path: path, dir: dir},  _scan.get_list_load);
      },

      get_list_load:function(e){
        let img   = _app.xhr_res(e).meta_data;
        let tmp   = _.template(_app.el('file-list-temp').innerHTML);
        let ele   = _app.el('file-list');
        let total = img.length-1;
        _scan.msg.innerHTML = 'Adding images';
        _.forOwn(img, function(v, k) {
           _app.el_html(ele, tmp({'idx': k, 'name':v.name, 'thumb':v.thumb, 'src': v.src,  'dir':_scan.dir, 'total':total}));
          });

        _scan.get_meta(img);

      },

      get_meta:function(img){
        _scan.msg.innerHTML = 'Perdicting Meta Data';
        _scan.imgs = img;
        _.forOwn(img, function(v, k) {
              el = _app.el('img-'+v.name+'-date');
              dt = (v.exif_date === null) ? v.file_date : v.exif_date;
              el.value = dt;

              if(v.latlng !== null && v.latlng[0] !== null){

                 _scan.msg.innerHTML = 'Location for'+k;
                 loc = _scan.get_geo(v.latlng);
                 if (loc !== null){
                  _app.el('img-'+v.name+'-loc-display').innerHTML = loc.name;
                  _app.el('img-'+v.name+'-loc').value = loc.id;
                  _app.el('img-'+v.name+'-section-display').innerHTML = loc.section__name;
                  _app.el('img-'+v.name+'-section').value = loc.section_id;
                 }
              }

        });
      },


      get_geo:function(latlng){
          var loc = null;
          var diff = 0;
          for(var key in _scan.locs){
            v = _scan.locs[key];
            if(loc === null) {
             diff = _scan.distance(v.lat, v.lng, latlng[0], latlng[1]);
             if (diff < 1.1){loc = v; break;}
            }
          }
        return loc;
      },


    distance:function(lat1, lon1, lat2, lon2) {
    // Converts numeric degrees to radians
    var toRad = function(Value) { return Value * Math.PI / 180;};
      var R = 6371; // km
      var dLat = toRad(lat2-lat1);
      var dLon = toRad(lon2-lon1);
      lat1 = toRad(lat1);
      lat2 = toRad(lat2);
      var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.sin(dLon/2) * Math.sin(dLon/2) * Math.cos(lat1) * Math.cos(lat2);
      var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      var d = R * c;
      return d;
    },




    modal:function(src, name) {


      // initialize modal element
      var modalEl = document.createElement('div');
      var modalIm = document.createElement('IMG');
      modalIm.src = src;
      //modalIm.align = 'middle';
      modalIm.style.width = 'auto';

      modalIm.style.height = 'auto';

      modalIm.style.display = 'block';
      modalIm.style.maxWidth = '750px';
      modalIm.style.maxHeight = '550px';

      modalIm.style.margin = '2px';

      modalEl.style.maxHeight = '850px';

      modalEl.appendChild(modalIm);
      modalEl.style.width  = '75%';
      modalEl.style.height = '75%';
      modalEl.style.margin = '100px auto';
      modalEl.style.overflow = 'hidden';
      modalEl.style.backgroundColor = '#fff';

      data = _scan.imgs[name];
      html = '';
      for(var key in data){
        html += '<p>'+ key + ': '+ data[key]+ "</p>";
      }

        var metadiv = document.createElement('div');
           metadiv.style.overflowY = 'auto';
           metadiv.style.height = '300px';
            metadiv.innerHTML = html
        modalEl.appendChild( metadiv );
     /*
{ latlng: (2) [â€¦],
name: "0904171416.jpg",
path: "/home/scotty/apps/picbiz/images/2018-05-12_09_25/0904171416.jpg", src: "/static/2018-05-12_09_25/0904171416.jpg",
  thumb: "/static/2018-05-12_09_25/thumbs/0904171416.jpg", dir: "2018-05-12_09_25", file_date: "2018-05-18", exif_date: null }
     */

      // show modal
      mui.overlay('on', modalEl);


  }





    };


    /*
      Enable filling of text fields
      from edit toolbar
    */
    const tag_editor = {

      init:() =>{
        tag_editor.company.init();
        tag_editor.loc.init();
        tag_editor.subject.init();
        tag_editor.section.init();
      },

      company:{
          select:'',
          btn:'',
          init:function(){
            tag_editor.company.select = _app.el('company-select');
            tag_editor.company.btn    = _app.el('evt-add-company');
            tag_editor.company.select_init();
          },
          select_init:()=>{
              _app.xhr_get('/company/index', {active:true}, (e)=>{
                tag_editor.company.select_events();
                tag_editor.company.select_load(_app.xhr_res(e));
              });
          },
          select_events:()=>{
            _app.event_add(tag_editor.company.btn, 'click', ()=>{
              var checkboxes = _app.query_dom("input[type='checkbox']:checked");
              checkboxes.forEach((node, idx)=>{
              _app.el(node.value+'-company-display').innerHTML = _app.option.txt(tag_editor.company.select);
              _app.el(node.value+'-company').value = tag_editor.company.select.value;
            });
            });
          },
          select_load:function(data){
            var _select = tag_editor.company.select
            var _option;
            _select.appendChild(_app.option.create(-1, ''));
            _.forOwn(data.companies, (v, k)=>{
              _select.appendChild(_app.option.create(v.id, v.name));
            });
            $(_select).select2({tags: true, selectOnBlur: true, multiple: false});
          }
      },


      loc:{
        select:'',
        btn:'',
        init:function(){
          tag_editor.loc.select = _app.el('loc-select');
          tag_editor.loc.btn    = _app.el('evt-add-loc');
          tag_editor.loc.select_init();
        },
        select_init:()=>{
            _app.xhr_get('/location/index', {active:true}, (e)=>{
              tag_editor.loc.select_events();
              tag_editor.loc.select_load(_app.xhr_res(e));
            });
        },
        select_events:()=>{
          _app.event_add(tag_editor.loc.btn, 'click', ()=>{
            var checkboxes = _app.query_dom("input[type='checkbox']:checked");
            checkboxes.forEach((node, idx)=>{
            _app.el(node.value+'-loc-display').innerHTML = _app.option.txt(tag_editor.loc.select);
            _app.el(node.value+'-loc').value = tag_editor.loc.select.value;
          });
          });
        },
        select_load:function(data){
          var _select = tag_editor.loc.select
          var _option;
          _select.appendChild(_app.option.create(-1, ''));
          _.forOwn(data.locations, (v, k)=>{
            _select.appendChild(_app.option.create(v.id, v.name));
          });
          $(_select).select2({tags: false, selectOnBlur: true, multiple: false});
        }
      },


      subject:{
        field:'',
        btn:'',
        init:function(){
          tag_editor.subject.field = _app.el('subject-select');
          tag_editor.subject.btn = _app.el('evt-add-subject');
          tag_editor.subject.select_events();
        },

        select_events:()=>{
          _app.event_add(tag_editor.subject.btn, 'click',()=>{
            var checkboxes = _app.query_dom("input[type='checkbox']:checked");
            checkboxes.forEach((node, idx)=>{
            _app.el(node.value+'-subject').value = tag_editor.subject.field.value;
          });
          });
        },
      },



      section:{
        select:'',
        btn:'',
        init:function(){
          tag_editor.section.select = _app.el('section-select');
          tag_editor.section.btn    = _app.el('evt-add-section');
          tag_editor.section.select_init();
        },
        select_init:()=>{
            _app.xhr_get('/section/index', {active:true}, (e)=>{
              tag_editor.section.select_events();
              tag_editor.section.select_load(_app.xhr_res(e));
            });
        },
        select_events:()=>{
          _app.event_add(tag_editor.section.btn, 'click', ()=>{
            var checkboxes = _app.query_dom("input[type='checkbox']:checked");
            checkboxes.forEach((node, idx)=>{
            _app.el(node.value+'-section-display').innerHTML = _app.option.txt(tag_editor.section.select);
            _app.el(node.value+'-section').value = tag_editor.section.select.value;
          });
          });
        },
        select_load:function(data){
          var _select = tag_editor.section.select
          var _option;
          _select.appendChild(_app.option.create(-1, ''));
          _.forOwn(data.sections, (v, k)=>{
            _select.appendChild(_app.option.create(v.id, v.name));
          });
          $(_select).select2({tags: false, selectOnBlur: true, multiple: false});
        }
      },

    };

    $(document).ready(() => {
      tag_editor.init();
      _scan.init("{{path}}", "{{mkdir.name}}");
      select_on_shift('#file-list', '.chkbox');
    });

</script>





{% endblock %}
